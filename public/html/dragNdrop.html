<?php
// Permettra de passer le tableau d'objet qui ressort du parsing et les données extraites/calculées pour les proposer
require('../../php/PointsGPX.php');
require('../../php/connexionDB.php');

session_start();
ob_start();


function calculateShortDistance($sourceLat,$sourceLong, $destinationLat,$destinationLong){
	   
  // latitude :   1° = 111km
  // longitude :  1° = 82km à Nice, 71 à Lille
  $degFactor = 6378.137 * M_PI / 180;
     
  // Latitude : correspondance angle en degrés -> km (fixe)
  $deg_lat = $degFactor;

  // longitude : correspondance angle en degrés -> km (dépend de la latitude)
  // on prend une latitude moyenne pour simplifier le calcul
  $moyLat = ($sourceLat+$destinationLat) / 2;
  $deg_long = cos( $moyLat * M_PI / 180) * $degFactor;
   
  // Différence des distances en km
  $a = $deg_lat * abs($sourceLat - $destinationLat);
  $b = $deg_long * abs($sourceLong - $destinationLong);
   
  // Racine de la somme des carrés (Pythagore)
  $c = pow(pow($a,2)+pow($b,2),1/2);
   
  return $c;
}

  function test_extension(){
      if(isset($_FILES['myFile']) && $_FILES['myFile']['size'] != 0){
        $finfo = finfo_open(FILEINFO_MIME_TYPE);
        $extension = finfo_file($finfo,$_FILES['myFile']['tmp_name']); // Va chercher l'image MIME du fichier qui se trouve à l'emplacement 'tmp_name' (nom du fichier dans le repertoire temporaire)

        if($extension != "text/xml"){
          echo "<span style=\"color:#d63024; text-align:center\"> Le fichier que vous souhaitez télécharger n'est pas un fichier GPX. </span>";
        } else { 
          parsing();
        }
    }
  }

  /*
    L'algorithme doit être amélioré pour parsé à la fois les rte et et les trk
  */
  function parsing(){

    $tab_points = new ArrayObject();
    $distance_course = 0;
    $elevation_max = 0;
    $denivele_positif = 0;
    $date_course = "";

    $duree_course = 0; // Faire soustraction


    $fichier_gpx = simplexml_load_file($_FILES['myFile']['tmp_name']);
    
    if(isset($fichier_gpx->metadata->time)){
      $date_course = (string)$fichier_gpx->metadata->time;
      $date_course = date("Y-m-m",strtotime($date_course));
    }


    foreach ($fichier_gpx->trk->trkseg as $tracksegment){
      foreach($tracksegment->trkpt as $trackpoint){
        $point = new PointsGPX((string)$trackpoint->time,(string)$trackpoint->attributes()->lat,(string)$trackpoint->attributes()->lon,(string)$trackpoint->ele); //besoin de mettre attributes() pour récupérer lon et lat
        $tab_points->append($point);
        /* Pour le moment on ne recupera pas les extensions, on ne veut pas les utiliser sur l'application
        et on permettra de récupérer le fichier GPX directement en le sauvegardant sur le serveur */
    
      }
    }

    $debut = $tab_points[0]->getTime();
    $debut = strtotime($debut);
    $fin = $tab_points[count($tab_points) - 1]->getTime();
    $fin = strtotime($fin);

    $difference = abs($fin - $debut);
    $difference = date('h:i:s',$difference);

    foreach ($tab_points as $k => $point){
      if($point->getEle() > $elevation_max){
        $elevation_max = $point->getEle();
      }
      if(isset($tab_points[$k-1])){
        if($point->getEle() > $tab_points[$k-1]->getEle()){
          $denivele_positif += $point->getEle() - $tab_points[$k-1]->getEle();
        }
      }
      if(isset($tab_points[$k+1])){
        $distance_course += calculateShortDistance($point->getLat(),$point->getLong(),$tab_points[$k+1]->getLat(),$tab_points[$k+1]->getLong());
      }
    
    }
    $_SESSION['date'] = $date_course;
    $_SESSION['elevation'] = $elevation_max;
    $_SESSION['denivele'] = $denivele_positif;
    $_SESSION['distance'] = $distance_course;
    $_SESSION['tableauPoints'] = $tab_points;
    $_SESSION['duree'] = $difference;
    
    header('location:add.html');
  }

?>

<!DOCTYPE html>

<head>
  <title>GPX - Upload</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta charset="utf-8" />
  <link rel="shortcut icon" href="/assets/favicon.ico" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" integrity="sha384-DyZ88mC6Up2uqS4h/KRgHuoeGwBcD4Ng9SiP4dIRy0EXTlnuz47vAwmeGwVChigm" crossorigin="anonymous">
  <link rel="stylesheet" href="../style.css" />
</head>

<body class="relative h-screen flex flex-col justify-center items-center bg-purple-400">

    <div class="card p-8 rounded-lg">
        <form action="" method="POST" enctype="multipart/form-data" class="flex flex-col gap-4 justify-center items-center">
            <h2 class="text-2xl text-center font-bold text-white mb-4">Dépot du fichier :</h2>  
            <div class="drop-zone font-Monserrat flex gap-8 w-full">
                <span class="drop-zone__prompt">Cliquez ou faites glisser le fichier ici</span>
                <input type="file" name="myFile" class="drop-zone__input" />
            </div>
            <?php if(isset($_FILES)) { test_extension();} ?>
            <input type="submit" value="Déposer" class="py-3 px-4 rounded-lg bg-purple-100 mt-4">
        </form>
    </div>  

  <script>
    document.querySelectorAll(".drop-zone__input").forEach((inputElement) => {
      const dropZoneElement = inputElement.closest(".drop-zone");

      dropZoneElement.addEventListener("click", (e) => {
        inputElement.click();
      });

      inputElement.addEventListener("change", (e) => {
        if (inputElement.files.length) {
          updateThumbnail(dropZoneElement, inputElement.files[0]);
        }
      });

      dropZoneElement.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZoneElement.classList.add("drop-zone--over");
      });

      ["dragleave", "dragend"].forEach((type) => {
        dropZoneElement.addEventListener(type, (e) => {
          dropZoneElement.classList.remove("drop-zone--over");
        });
      });

      dropZoneElement.addEventListener("drop", (e) => {
        e.preventDefault();

        if (e.dataTransfer.files.length) {
          inputElement.files = e.dataTransfer.files;
          updateThumbnail(dropZoneElement, e.dataTransfer.files[0]);
        }

        dropZoneElement.classList.remove("drop-zone--over");
      });
    });

    /**
     * Updates the thumbnail on a drop zone element.
     *
     * @param {HTMLElement} dropZoneElement
     * @param {File} file
     */
    function updateThumbnail(dropZoneElement, file) {
      let thumbnailElement = dropZoneElement.querySelector(".drop-zone__thumb");

      // First time - remove the prompt
      if (dropZoneElement.querySelector(".drop-zone__prompt")) {
        dropZoneElement.querySelector(".drop-zone__prompt").remove();
      }

      // First time - there is no thumbnail element, so lets create it
      if (!thumbnailElement) {
        thumbnailElement = document.createElement("div");
        thumbnailElement.classList.add("drop-zone__thumb");
        dropZoneElement.appendChild(thumbnailElement);
      }

      thumbnailElement.dataset.label = file.name;

      // Show thumbnail for image files
      if (file.type.startsWith("image/")) {
        const reader = new FileReader();

        reader.readAsDataURL(file);
        reader.onload = () => {
          thumbnailElement.style.backgroundImage = `url('${reader.result}')`;
        };
      } else {
        thumbnailElement.style.backgroundImage = null;
      }
    }
  </script>
</body>
